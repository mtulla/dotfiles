#!/bin/bash
set -euo pipefail

{{ template "script-helpers" }}

{{ if eq .chezmoi.os "darwin" -}}
# macOS: install Homebrew if missing, then update
if ! command_exists brew; then
    info "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv)"
else
    success "Homebrew already installed"
fi

info "Updating Homebrew..."
brew update
{{ else -}}
# Linux: verify Debian-based, check sudo, update apt
if [[ ! -f /etc/debian_version ]]; then
    error "This setup is for Debian/Ubuntu only."
    exit 1
fi

if ! command_exists sudo; then
    error "sudo is required. Install it first: apt install sudo"
    exit 1
fi

info "Updating apt..."
sudo apt update
{{ end -}}

success "Package manager ready"
